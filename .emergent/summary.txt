<analysis>original_problem_statement:
The user wants to build **JarlPM**, an AI-agnostic, conversation-driven Product Management system.

**PRODUCT REQUIREMENTS (Authoritative):**

1.  **Core Product:** A tool for Product Managers to create and refine Epics, Features, User Stories, and Bugs. The core unit of value is the Epic.
2.  **LLM Architecture:**
    *   **AI-Agnostic:** Users bring their own API keys for providers like OpenAI, Anthropic, or a local LLM.
    *   **Server-Side Agent Pattern:** The system must use a server-side Prompt Registry to orchestrate LLM interactions, not provider-native agent runtimes. Prompts are versioned and stage-specific.
3.  **Subscription Model:** A 0/month subscription is required for AI features, managed via Stripe. Inactive subscriptions block AI calls but preserve data.
4.  **Epic Lifecycle (Monotonic State Machine):** An Epic must progress through the following stages without regression:  ->  (locked) ->  ->  (locked) ->  ->  (immutable).
5.  **Sacred Invariants:** Confirmed decisions, conversation history, and user intent are immutable and append-only. Stage locks cannot be bypassed.
6.  **Database Migration (MongoDB to PostgreSQL):** The entire application must be migrated from MongoDB to PostgreSQL (using Neon). PostgreSQL will be the single source of truth, enforcing relational integrity, append-only constraints, and transactional safety.
7.  **Data Model (PostgreSQL):** Must include tables for , , , , , , , , and .
8.  **Frontend Requirements:**
    *   An Epic Page displaying the stage, locked sections, conversation transcript, and a UI for pending proposals from the LLM.
    *   State must be fully rehydrated when an Epic is resumed.
    *   Authentication via Google OAuth.
9.  **UI/Branding (Nordic Theme):** The UI must use a muted, professional, and calm Nordic color palette inspired by the Norwegian flag (but not a literal copy). The theme must support both light and dark modes and use centralized design tokens. All colors must be desaturated and softened.

**User's preferred language**: English

**what currently exists?**
The agent has successfully scaffolded a full-stack application using FastAPI for the backend and React for the frontend.
- **Backend:** Initially built with MongoDB, but a migration to PostgreSQL (Neon) is in progress. The agent has installed SQLAlchemy and psycopg2, and created the initial database connection logic and ORM models in . The service layer (, , ) has been updated to use the new SQLAlchemy-based database session.
- **Frontend:** A complete UI has been built with React, Zustand for state management, and Tailwind CSS. It includes a landing page, dashboard, settings page, and the main epic workflow page.
- **Theming:** A sophisticated, dual-mode (light/dark) Nordic theme has been implemented as per the user's detailed specifications, using CSS variables and Tailwind CSS configuration. The theme is fully integrated across all pages.

The application is currently in a non-runnable state because the database migration is incomplete. The API routes have not yet been updated to use the new PostgreSQL session, causing a mismatch with the updated service layer.

**Last working item**:
    - Last item agent was working on: The agent was in the process of migrating the application's database from MongoDB to PostgreSQL (Neon). It had just finished updating the service layer files (, , ) to use the new SQLAlchemy-based database logic. The next step was to update the API routes to align with this change.
    - Status: IN PROGRESS
    - Agent Testing Done: N
    - Which testing method agent to use? backend testing agent
    - User Testing Done: N

**All Pending/In progress Issue list**:
  Issue 1:  The application is broken due to an incomplete database migration. The backend services have been updated to use PostgreSQL, but the API routes in  still contain MongoDB-specific logic. This will cause the application to fail at runtime. (Priority: P0)

  Issues Detail:
  - Issue 1:
     - Attempted fixes: No fixes have been attempted yet. The agent was systematically working through the migration and was about to address this part.
     - Next debug checklist:
        1.  Review all files in  (, , , ).
        2.  For each route, replace MongoDB client calls with the new SQLAlchemy session and ORM models.
        3.  Specifically, update how the database session is obtained (dependency injection) and how data is queried and committed.
        4.  Update the main  to initialize the PostgreSQL database and create all tables on startup.
     - Why fix this issue and what will be achieved with the fix? This is the most critical step to complete the database migration. Fixing this will make the backend functional again, using PostgreSQL as the source of truth.
     - Status:  IN PROGRESS
     - Is recurring issue? N
     - Should Test frontend/backend/both after fix? backend
     - Blocked on other issue: None

**In progress Task List**:
  - Task 1: Complete MongoDB to PostgreSQL Migration
     - Where to resume: The agent needs to start by updating the API route files located in .
     - What will be achieved with this? The application will use PostgreSQL as its database, fulfilling a core requirement. This will enable the implementation of relational integrity, transactions, and database-level constraints for the application's sacred invariants.
     - Status: IN PROGRESS
     - Should Test frontend/backend/both after fix? both
     - Blocked on something: None

**Upcoming and Future Tasks**
    Upcoming Tasks:
    - **P0: Finalize DB Schema and Constraints:** After the code migration, create a script or ensure  creates all necessary tables, indexes, and DB-level constraints (e.g., CHECK constraints for monotonic stage progression, triggers for append-only tables) as specified in the migration directive.
    - **P1: Full E2E Workflow Test:** With the PostgreSQL backend running, perform an end-to-end test of the entire Epic creation and state transition workflow. This includes configuring an LLM provider, sending messages, generating proposals, and confirming them to advance the Epic's stage.
    - **P1: Validate Server-Side Enforcement:** Rigorously test that all sacred invariants (append-only logs, monotonic state, locked content) are being enforced by the new PostgreSQL backend. Attempt to violate these rules via the API to ensure they are blocked.

    Future Tasks:
    - **P2: Implement Deletion Semantics:** Implement the hard-delete functionality for Epics, ensuring it requires explicit user confirmation and correctly cascades through related records.
    - **P2: Implement Prompt Registry:** Build the full Prompt Registry system as defined in the requirements, with versioned, stage-specific prompts stored in the database.

**Completed work in this session**
- **Full-Stack Application Scaffolding:**
  - Created a FastAPI backend structure with initial models, routes, and services.
  - Created a React frontend with pages for Landing, Dashboard, Settings, and the core Epic workflow.
- **State Management:**
  - Implemented Zustand for global state management on the frontend ().
- **Nordic UI & Theming:**
  - Implemented a complete, dual-mode (light/dark) Nordic theme based on user-provided color palettes.
  - Centralized theme tokens in  and .
  - Created a  component and integrated it.
- **Backend API Development (Initial):**
  - Created initial API endpoints for authentication, epics, LLM providers, and subscriptions.
- **Linting & Code Cleanup:**
  - Addressed multiple ESLint errors and warnings across the frontend codebase.
- **Database Migration (Started):**
  - Installed  and .
  - Created the PostgreSQL database layer () and ORM models ().
  - Updated the service layer to use the new database connection.

**Earlier issues found/mentioned but not fixed**
   - Issue 1: Authenticated Screenshot Failures
     - Debug checklist: When taking a screenshot of an authenticated page (like ), the agent creates a test session cookie. However, this cookie is set for , while the screenshot tool navigates to the preview domain, causing a redirect to the login page. The agent noted this but moved on. A potential fix is to ensure the screenshot tool can be configured to use cookies for a specific domain.
     - Why to solve this issue and what will be achieved with this? Solving this will allow the agent to visually verify authenticated pages, which is crucial for frontend development and testing.
     - Should Test frontend/backend/both after fix: frontend
     - Is recurring issue? Y

**Known issue recurrence from previous fork**
  - N/A

**Code Architecture**


**Key Technical Concepts**
- **Backend:** FastAPI, PostgreSQL (Neon), SQLAlchemy (ORM)
- **Frontend:** React, Tailwind CSS, Zustand (State Management)
- **Authentication:** Google OAuth
- **Payments:** Stripe (planned)
- **Architecture:** AI-agnostic, Server-side agent pattern, Monotonic state machine

**key DB schema**
Defined in  (SQLAlchemy ORM):
- **User:** uid=0(root) gid=0(root) groups=0(root), , , , , 
- **Subscription:** uid=0(root) gid=0(root) groups=0(root),  (FK to User), , , , 
- **LLMProviderConfig:** uid=0(root) gid=0(root) groups=0(root),  (FK to User), , , 
- **Epic:** uid=0(root) gid=0(root) groups=0(root),  (FK to User), , 
- **EpicSnapshot:** uid=0(root) gid=0(root) groups=0(root),  (FK to Epic), , , 
- **EpicTranscriptEvent:** uid=0(root) gid=0(root) groups=0(root),  (FK to Epic), , , 
- **EpicDecision:** uid=0(root) gid=0(root) groups=0(root),  (FK to Epic), , 
- **EpicArtifact:** uid=0(root) gid=0(root) groups=0(root),  (FK to Epic), , 
- **PromptTemplate:** uid=0(root) gid=0(root) groups=0(root), , , , 

**changes in tech stack**
- **Database:** Major migration from MongoDB to PostgreSQL (Neon).

**All files of reference**
- : New file. Contains SQLAlchemy engine and session setup for PostgreSQL.
- : New file. Defines all application tables using SQLAlchemy ORM.
- , , : Updated to use the new PostgreSQL database session instead of MongoDB.
- : All files in this directory need to be updated to use PostgreSQL.
- : Updated to define the precise Nordic color palette.
- : Updated with CSS variables for the Nordic theme.
- : All page components were overwritten to implement the Nordic theme.
- : Created to store the project requirements.

**Areas that need refactoring**:
- The agent used an  comment in  to suppress a  error. While deemed necessary for the auth flow, this could be reviewed for a cleaner solution that avoids disabling lint rules.

**key api endpoints**
- : Handles Google OAuth callback.
- : Fetches the current user's profile.
- : Logs out the user.
- : Fetches all epics for the user.
- : Creates a new epic.
- : Fetches a single epic's details.
- : Sends a message to the chat for an epic.
- : Gets the user's configured LLM provider.
- : Saves or updates the user's LLM provider settings.
- : Checks the user's subscription status.
- : Creates a Stripe checkout session.

**Critical Info for New Agent**
You are picking up in the middle of a critical database migration from MongoDB to PostgreSQL. The backend is currently **non-functional**. Your immediate priority is to complete this migration.

1.  **Update API Routes:** Modify all files in  to remove all MongoDB logic and replace it with the SQLAlchemy session and ORM models from .
2.  **Update :** Modify  to initialize the PostgreSQL database on startup (). Remove all MongoDB-related setup.
3.  **Environment Variable:** The PostgreSQL connection string is provided via the  environment variable. Ensure your database logic reads from this.
4.  **Test Thoroughly:** Once the migration is complete, you must restart the backend and thoroughly test all API endpoints to ensure they work correctly with the new database. After that, perform a full end-to-end test from the frontend.

**documents and test reports created in this job**
- 
- 
- 

**Last 10 User Messages and any pending HUMAN messages**
1.  **User:** Provided a detailed directive to migrate the database from MongoDB to PostgreSQL (Neon), including schema requirements, ORM choice, and transaction/constraint enforcement. (IN PROGRESS)
2.  **User:** Provided a locked, precise Nordic v1 color palette with specific hex codes for light and dark themes. (COMPLETED)
3.  **User:** Provided a guardrail amendment for a Nordic UI theme, emphasizing a muted, calm, professional aesthetic and requiring light/dark modes. (COMPLETED)
4.  **Agent:** Summarized the completed MVP and listed next steps. (COMPLETED)
5.  **Agent:** Completed the implementation of the Nordic theme overhaul. (COMPLETED)
6.  **Agent:** Confirmed the app compiled successfully. (COMPLETED)
7.  **Agent:** Fixed several linting issues. (COMPLETED)
8.  **Agent:** Identified a cookie domain issue preventing authenticated screenshots. (NOT RESOLVED)
9.  **Agent:** Ran the testing agent, which reported a 93.3% backend success rate. (COMPLETED)
10. **Agent:** Started the MongoDB to PostgreSQL migration by installing dependencies and creating the new DB layer. (IN PROGRESS)

**Project Health Check:**
- **Broken:** The backend is non-functional due to the in-progress database migration. API routes are out of sync with the updated service layer.
- **Mocked:** N/A

**3rd Party Integrations**
- **Google OAuth:** For user authentication. The flow is implemented but requires real-world testing. Uses User-provided keys configured on the platform.
- **Stripe:** For subscriptions. A checkout flow is partially implemented. Requires a User-provided API key.
- **OpenAI / Anthropic / Local LLM:** Planned integrations. The system is designed to use User-provided API keys for these services. The UI for configuration exists.

**Testing status**
  - Testing agent used after significant changes: YES (once)
  - Troubleshoot agent used after agent stuck in loop: NO
  - Test files created: None
  - Known regressions: The entire backend is currently non-functional due to the incomplete migration.

**Credentials to test flow:**
The agent used a  tool which generates a test user and session token. The next agent should use the same tool to test authenticated flows. Example command: 

**What agent forgot to execute**
The agent did not forget but rather is in the middle of a multi-step task. The most critical pending action is updating the API routes in  to complete the PostgreSQL migration. It has also not yet implemented the database-level constraints (e.g., CHECK constraints, triggers for append-only tables) which were part of the migration directive.</analysis>
